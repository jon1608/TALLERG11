<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Detalle de Factura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <h2>Detalle de Factura</h2>

    <p><strong>Fecha:</strong> <span th:text="${factura.fecha}"></span></p>
    <p><strong>Cliente:</strong> <span th:text="${factura.cliente.nombreCompleto}"></span></p>
    <p><strong>Placa del Vehículo:</strong>
        <span th:text="${factura.vehiculo != null ? factura.vehiculo.placa : 'Sin vehículo'}"></span>
    </p>

    <h4>Ítems</h4>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Descripción</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="item : ${factura.items}">
                <td th:text="${item.descripcion}"></td>
                <td th:text="${item.cantidad}"></td>
                <td th:text="${#numbers.formatDecimal(item.precioUnitario, 1, 2)}"></td>
                <td th:text="${#numbers.formatDecimal(item.cantidad * item.precioUnitario, 1, 2)}"></td>
            </tr>
        </tbody>
    </table>

    <p><strong>Subtotal:</strong> ₡<span th:text="${#numbers.formatDecimal(factura.subtotal, 1, 2)}"></span></p>
    <p><strong>IVA:</strong> ₡<span th:text="${#numbers.formatDecimal(factura.iva, 1, 2)}"></span></p>
    <p><strong>Total:</strong> ₡<span th:text="${#numbers.formatDecimal(factura.total, 1, 2)}"></span></p>

    <div class="mt-4 d-flex gap-2">
        <a th:href="@{/menu}" class="btn btn-primary">Volver al Menú</a>
        <a th:href="@{/admin/facturas}" class="btn btn-secondary">Volver a Facturas</a>

        <!-- ✅ Botón GUARDAR FACTURA desde la vista de detalle -->
        <form th:action="@{/admin/facturas/guardar}" method="post" th:object="${factura}" class="d-inline">

            <!-- Si usas Spring Security con CSRF habilitado, descomenta: -->
            <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> -->

            <!-- Identificadores principales -->
            <input type="hidden" th:field="*{id}">
            <input type="hidden" th:field="*{cliente.id}">
            <input type="hidden" th:field="*{vehiculo.id}">

            <!-- Ítems (reenviados tal cual) -->
            <div th:each="item,iter : *{items}">
                <input type="hidden" th:name="${'items[' + iter.index + '].descripcion'}"   th:value="${item.descripcion}">
                <input type="hidden" th:name="${'items[' + iter.index + '].cantidad'}"      th:value="${item.cantidad}">
                <input type="hidden" th:name="${'items[' + iter.index + '].precioUnitario'}" th:value="${item.precioUnitario}">
            </div>

            <!-- Totales no son necesarios, el controller los recalcula -->
            <button type="submit" class="btn btn-success">Guardar Factura</button>
        </form>
    </div>
</body>
</html>
