<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Detalle de Factura</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">

  <h2>Detalle de Factura</h2>

  <!-- Alertas flash -->
  <div th:if="${mensaje}" class="alert alert-success alert-dismissible fade show" role="alert">
    <span th:text="${mensaje}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <span th:text="${error}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>

  <p><strong>Fecha:</strong> <span th:text="${factura.fecha}"></span></p>
  <p><strong>Cliente:</strong> <span th:text="${factura.cliente.nombreCompleto}"></span></p>
  <p><strong>Placa del Vehículo:</strong>
    <span th:text="${factura.vehiculo != null ? factura.vehiculo.placa : 'Sin vehículo'}"></span>
  </p>

  <h4>Ítems</h4>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Descripción</th>
        <th>Cantidad</th>
        <th>Precio Unitario</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="item : ${factura.items}">
        <td th:text="${item.descripcion}"></td>
        <td th:text="${item.cantidad}"></td>
        <td th:text="${#numbers.formatDecimal(item.precioUnitario, 1, 2)}"></td>
        <td th:text="${#numbers.formatDecimal(item.cantidad * item.precioUnitario, 1, 2)}"></td>
      </tr>
    </tbody>
  </table>

  <!-- Totales y resumen de pagos -->
  <div class="row g-3">
    <div class="col-md-6">
      <div class="border rounded p-3">
        <p class="mb-1"><strong>Subtotal:</strong> ₡<span th:text="${#numbers.formatDecimal(factura.subtotal, 1, 2)}"></span></p>
        <p class="mb-1"><strong>IVA:</strong> ₡<span th:text="${#numbers.formatDecimal(factura.iva, 1, 2)}"></span></p>
        <p class="mb-1"><strong>Total:</strong> ₡<span th:text="${#numbers.formatDecimal(factura.total, 1, 2)}"></span></p>

        <!-- Si agregaste los métodos @Transient en Factura.java -->
        <hr>
        <p class="mb-1"><strong>Pagado:</strong> ₡
          <span th:text="${#numbers.formatDecimal(factura.totalPagado != null ? factura.totalPagado : 0, 1, 2)}"></span>
        </p>
        <p class="mb-0"><strong>Saldo:</strong> ₡
          <span th:text="${#numbers.formatDecimal(factura.saldoPendiente != null ? factura.saldoPendiente : (factura.total - (totalPagado?:0)), 1, 2)}"></span>
        </p>
      </div>
    </div>

    <!-- Formulario: Registrar pago -->
    <div class="col-md-6">
      <div class="border rounded p-3">
        <h5 class="mb-3">Registrar Pago</h5>
        <form th:action="@{/admin/pagos/registrar}" method="post" class="row gy-2 gx-3 align-items-end">
          <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"> -->
          <input type="hidden" name="facturaId" th:value="${factura.id}"/>

          <div class="col-6">
            <label class="form-label">Monto</label>
            <input type="number" step="0.01" min="0.01" name="monto" class="form-control" required>
          </div>

          <div class="col-6">
            <label class="form-label">Método</label>
            <select name="metodo" class="form-select" required>
              <option value="EFECTIVO">Efectivo</option>
              <option value="TARJETA">Tarjeta</option>
              <option value="TRANSFERENCIA">Transferencia</option>
              <option value="SINPE">SINPE</option>
            </select>
          </div>

          <div class="col-6">
            <label class="form-label">Referencia</label>
            <input type="text" name="referencia" class="form-control" placeholder="últimos 4 digitos comprobante.">
          </div>

          <div class="col-6">
            <label class="form-label">Observación</label>
            <input type="text" name="observacion" class="form-control" placeholder="Opcional">
          </div>

          <div class="col-12">
            <button type="submit" class="btn btn-success">Registrar Pago</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Lista de pagos (si quieres mostrar historial) -->
  <div class="mt-4">
    <h5>Pagos registrados</h5>
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Método</th>
          <th>Monto</th>
          <th>Referencia</th>
          <th>Estado</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="p : ${pagos}">
          <td th:text="${p.fechaPago}"></td>
          <td th:text="${p.metodo}"></td>
          <td>₡<span th:text="${#numbers.formatDecimal(p.monto, 1, 2)}"></span></td>
          <td th:text="${p.referencia}"></td>
          <td>
            <span th:text="${p.estado}"></span>
          </td>
          <td class="text-end">
            <form th:action="@{|/admin/pagos/${p.id}/anular|}" method="post" class="d-inline">
              <input type="hidden" name="facturaId" th:value="${factura.id}">
              <button type="submit" class="btn btn-outline-danger btn-sm"
                      th:disabled="${p.estado.name() == 'CANCELADO'}">Anular</button>
            </form>
            <form th:action="@{|/admin/pagos/${p.id}/confirmar|}" method="post" class="d-inline ms-1">
              <input type="hidden" name="facturaId" th:value="${factura.id}">
              <button type="submit" class="btn btn-outline-success btn-sm"
                      th:disabled="${p.estado.name() == 'CONFIRMADO'}">Confirmar</button>
            </form>
          </td>
        </tr>
        <tr th:if="${#lists.isEmpty(pagos)}">
          <td colspan="6" class="text-center text-muted">No hay pagos registrados.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="mt-3 d-flex gap-2">
    <a th:href="@{/menu}" class="btn btn-primary">Volver al Menú</a>
    <a th:href="@{/admin/facturas}" class="btn btn-secondary">Volver a Facturas</a>

    <!-- Guardar factura (tu botón existente) -->
    <form th:action="@{/admin/facturas/guardar}" method="post" th:object="${factura}" class="d-inline">
      <input type="hidden" th:field="*{id}">
      <input type="hidden" th:field="*{cliente.id}">
      <input type="hidden" th:field="*{vehiculo.id}">
      <div th:each="item,iter : *{items}">
        <input type="hidden" th:name="${'items[' + iter.index + '].descripcion'}"   th:value="${item.descripcion}">
        <input type="hidden" th:name="${'items[' + iter.index + '].cantidad'}"      th:value="${item.cantidad}">
        <input type="hidden" th:name="${'items[' + iter.index + '].precioUnitario'}" th:value="${item.precioUnitario}">
      </div>
      <button type="submit" class="btn btn-success">Guardar Factura</button>
    </form>
  </div>

</body>
</html>
