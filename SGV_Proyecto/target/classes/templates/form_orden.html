<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${orden.id == null} ? 'Nueva Orden' : 'Editar Orden'">Orden de Reparación</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

  <h2 th:text="${orden.id == null} ? 'Nueva Orden de Reparación' : 'Editar Orden de Reparación'"></h2>

  <a th:href="@{/menu}" class="btn btn-secondary mb-3">Volver al Menú Principal</a>
  <a th:href="@{/mecanico/ordenes}" class="btn btn-outline-primary mb-3">Volver a Listado</a>

  <form th:action="@{/mecanico/ordenes/guardar}" th:object="${orden}" method="post" class="row g-3">
    <input type="hidden" th:field="*{id}" />

    <div class="col-md-6">
      <label class="form-label">Estado</label>
      <input type="text" th:field="*{estado}" class="form-control" required />
    </div>

    <!-- CLIENTE -->
    <div class="col-md-6">
      <label class="form-label">Cliente</label>
      <select id="clienteSelect" th:field="*{cliente.id}" class="form-select" required>
        <option value=""
                th:selected="${orden.cliente == null or orden.cliente.id == null}">
          -- Seleccione --
        </option>
        <option th:each="cliente : ${clientes}"
                th:value="${cliente.id}"
                th:text="${cliente.nombreCompleto}">
        </option>
      </select>
    </div>

    <!-- VEHÍCULO (dependiente de Cliente) -->
    <div class="col-md-6">
      <label class="form-label">Vehículo (Placa)</label>
      <select id="vehiculoSelect" th:field="*{vehiculo.id}" class="form-select" required disabled>
        <option value="">-- Seleccione un cliente primero --</option>
      </select>
    </div>

    <div class="col-12">
      <label class="form-label">Descripción</label>
      <textarea th:field="*{descripcion}" class="form-control" rows="4" required></textarea>
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-success">Guardar Orden</button>
    </div>
  </form>

  <!-- JS: Cliente -> Vehículos -->
  <script>
    (function () {
      const clienteSelect  = document.getElementById('clienteSelect');
      const vehiculoSelect = document.getElementById('vehiculoSelect');

      function bloquearVehiculos(msg) {
        vehiculoSelect.innerHTML = '';
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = msg || '-- Seleccione un cliente primero --';
        vehiculoSelect.appendChild(opt);
        vehiculoSelect.disabled = true;
      }

      async function cargarVehiculos(clienteId, vehiculoSeleccionado) {
        bloquearVehiculos('-- Cargando vehículos… --');
        try {
          const resp = await fetch(`/admin/vehiculos/cliente/${clienteId}/placas`, {
            headers: { 'Accept': 'application/json' }
          });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json(); // [{id, placa}, ...]

          vehiculoSelect.innerHTML = '';
          if (!data || data.length === 0) {
            bloquearVehiculos('-- Sin vehículos registrados --');
            return;
          }

          const opt0 = document.createElement('option');
          opt0.value = '';
          opt0.textContent = '-- Seleccione --';
          vehiculoSelect.appendChild(opt0);

          data.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.id;        // id del vehículo
            opt.textContent = v.placa;
            if (vehiculoSeleccionado && String(vehiculoSeleccionado) === String(v.id)) {
              opt.selected = true;
            }
            vehiculoSelect.appendChild(opt);
          });

          vehiculoSelect.disabled = false;
        } catch (e) {
          console.error(e);
          bloquearVehiculos('-- Error al cargar vehículos --');
        }
      }

      // Cambio de cliente -> cargar placas
      clienteSelect.addEventListener('change', (e) => {
        const id = e.target.value;
        if (!id) { bloquearVehiculos(); return; }
        cargarVehiculos(id, null);
      });

      // Si venimos con datos (editar o reintento por validación), precargar:
      window.addEventListener('DOMContentLoaded', () => {
        const clientePre = clienteSelect.value; // si th:field trae valor
        // Thymeleaf no puede poner un valor válido en vehiculoSelect aún (está vacío),
        // así que leemos el posible valor del modelo via atributo data-* como fallback.
        // Si no lo usas, ignora esta parte.
        const vehiculoPre = /*[[${orden.vehiculo != null ? orden.vehiculo.id : null}]]*/ null;

        if (clientePre) {
          cargarVehiculos(clientePre, vehiculoPre);
        } else {
          bloquearVehiculos();
        }
      });
    })();
  </script>

</body>
</html>
